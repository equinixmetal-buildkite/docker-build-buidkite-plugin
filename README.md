# docker-build

This Buildkite plugin will build a container given a Dockerfile, a context path and a tag or a set of tags. It also accepts tags and labels generated by the [`docker-metadata` BuildKite plugin](https://github.com/equinixmetal-buildkite/docker-metadata-buidkite-plugin).

## Example

Add the following to your `pipeline.yml`:

```yml
steps:
  - command: ls
    plugins:
      - equinixmetal-buildkite/docker-build#v0.1.1:
          tags:
          - 'my-org/my-image:latest'
```

The default settings will build a container with a tag `my-org/my-image:latest` given that the repository continers a `Dockerfile` file on the top of the git repository root. It will also use the `.` directory as the context path.

The following example will shows how this plugin can be integrated with the `docker-metadata` plugin.

```yml
steps:
  - command: ls
    plugins:
      - equinixmetal-buildkite/docker-metadata#v0.1.2:
          images:
          - 'my-org/my-image'
          extra_tags:
          - latest
      - equinixmetal-buildkite/docker-build#v0.2.0: {}
```

This will build a container in a similar fashion as the example above. Except that
it will also generate a tag with the commit hash, as well as labels that help triage
where the commit came from.

## Configuration

### `dockerfile` (Optional, string)

Path to the Dockerfile to use. If not specified, the plugin will look for a `Dockerfile` file on the top of the git repository root.

### `context` (Optional, string)

Path to the context directory to use. If not specified, the plugin will use the `.` directory as the context path.

### `secret-file` (Optional, string)

A string like 'id=mysecret,src=secret-file' where <secret-file> is the path in the build (This enables [Docker Buildkit](https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information), also)

### `tags` (Optional, array of strings)

Tags to use when building the container. The plugin may also populate these tags with metadata generated by the `docker-metadata` plugin.

### `labels` (Optional, array of strings)

Labels to use when building the container. The plugin may also populate these labels with metadata generated by the `docker-metadata` plugin.

### `push` (Optional, boolean)

If set to `true`, the plugin will push the container to a registry. Defaults to `false`.

## Developing

To run the tests:

```bash
make test
```

## Contributing

1. Fork the repo
2. Make the changes
3. Run the tests
4. Commit and push your changes
5. Send a pull request
